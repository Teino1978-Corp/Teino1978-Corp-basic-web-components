<!--
A single-selection list box that supports selection highlighting (using the
system highlight color) and keyboard navigation.

The user can select an item with the mouse/touch or keyboard: Up/Down, Page
Up/Down, Home/End.

Like other Basic Web Components, this can handle distributed content: you can
include a content element inside a basic-list-box, and the list will navigate
through the distributed content. Note: for the time being, if you do use basic-
list-box inside your own component, it appears that you'll need to wire up your
own keyboard navigation, and forward the list navigation keys to the basic-list-
box.

This component includes basic ARIA support to provide a reasonable default
experience, e.g., for screen readers. The list component itself will be assigned
an appropriate ARIA role (default is "listbox"). The ID of the selected item
will be reflected in an "aria-activedescendant" attribute applied to the list.
To support this feature, all items in the list need unique IDs. If an item does
not have an ID, basic-list-box will automatically assign a default ID.

The keyboard interaction model generally follows that of Microsoft Windows'
list boxes instead of those in OS X:

* The Page Up/Down and Home/End keys actually move the selection, rather than
  just scrolling the list. The former behavior seems more generally useful for
  keyboard users.

* Pressing Page Up/Down will move the selection to the topmost/bottommost
  visible item if the selection is not already there. Thereafter, the key will
  move the selection up/down by a page, and (per the above point) make the
  selected item visible.

Programmatically selecting an item (by setting the selected property) scrolls
the item into view.

@element basic-list-box
@demo http://basic-web-components.github.io/components/basic-list-box/
-->

<!--
TODO: Restore the following features, currently lost in the transition from
Polymer 0.5 to Polymer 0.8:

The user can also select an item by typing the beginning of
an item's text.

-->

<link rel="import" href="../basic-aspect/basic-aspect.html">
<link rel="import" href="../basic-keyboard/basic-keyboard.html">
<link rel="import" href="../basic-keyboard-direction/basic-keyboard-direction.html">
<link rel="import" href="../basic-keyboard-paging/basic-keyboard-paging.html">
<link rel="import" href="../basic-children-content/basic-children-content.html">
<link rel="import" href="../basic-content-items/basic-content-items.html">
<link rel="import" href="../basic-item-selection/basic-item-selection.html">
<link rel="import" href="../basic-tap-selection/basic-tap-selection.html">
<link rel="import" href="../basic-direction-selection/basic-direction-selection.html">
<link rel="import" href="../basic-accessible-list/basic-accessible-list.html">
<link rel="import" href="../basic-selection-highlight/basic-selection-highlight.html">

<script src="../basic-shared/Generic.js"></script>

<dom-module id="basic-list-box">
  <style>
  :host {
    display: -webkit-flex;
    display: flex;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
  }

  [target="child"] {
    display: -webkit-flex;
    display: flex;
    -webkit-flex: 1;
    flex: 1;
  }

  #itemsContainer {
    -webkit-flex: 1;
    flex: 1;
    -webkit-overflow-scrolling: touch;
    overflow-y: scroll; /* for momentum scrolling */
  }

  /* Generic appearance */
  :host([generic=""]) {
    border: 1px solid gray;
    box-sizing: border-box;
    cursor: default;
  }

  :host([generic=""]) #itemsContainer ::content > * {
    padding: 0.25em;
  }
  </style>
  <template>
    <basic-keyboard-direction></basic-keyboard-direction>
    <basic-keyboard-paging></basic-keyboard-paging>
    <basic-direction-selection></basic-direction-selection>
    <basic-selection-highlight></basic-selection-highlight>
    <basic-accessible-list></basic-accessible-list>
    <basic-content-items></basic-content-items>
    <basic-item-selection></basic-item-selection>
    <basic-keyboard target="child">
      <basic-tap-selection target="child">
        <basic-children-content id="itemsContainer">
          <content></content>
        </basic-children-content>
      </basic-tap-selection>
    </basic-keyboard>
  </template>
</dom-module>

<script>
Polymer({

  behaviors: [
    Basic.Aspect,
    Basic.Generic
  ],

  contribute: {
    // Keep the selected item in view.
    // TODO: This behavior seems useful in more places than just list boxes.
    // Consider moving it into its own aspect.
    set selectedItem(item) {
      if (item) {
        this._scrollItemIntoView(item);
      }
    }
  },

  hostAttributes: {
    target: 'shadow'
  },

  is: 'basic-list-box',

  // Scroll the given element completely into view, minimizing the degree of
  // scrolling performed.
  //
  // Blink has a scrollIntoViewIfNeeded() function that almost does what we
  // want, but unfortunately it's non-standard, and in any event often ends up
  // scrolling more than is absolutely necessary.
  _scrollItemIntoView: function(item) {
    // Get the relative position of the item with respect to the top of the
    // list's scrollable canvas. An item at the top of the list will have a
    // elementTop of 0.
    var innermost = this.collective.innermostAttached;
    if (!innermost) {
      return;
    }

    var elementTop = item.offsetTop - innermost.offsetTop - innermost.clientTop;
    var elementBottom = elementTop + item.offsetHeight;
    // Determine the bottom of the scrollable canvas.
    var scrollBottom = innermost.scrollTop + innermost.clientHeight;
    if (elementBottom > scrollBottom) {
      // Scroll up until item is entirely visible.
      innermost.scrollTop += elementBottom - scrollBottom;
    }
    else if (elementTop < innermost.scrollTop) {
      // Scroll down until item is entirely visible.
      innermost.scrollTop = elementTop;
    }
  }

});

/*
 * The following comments document API members provided by mixins. Ideally these
 * docs will eventually be pulled from the mixin source files, but for now are
 * copied here by hand.
 */

/**
 * True if the component would like to receive generic styling.
 *
 * This property is true by default — set it to false to turn off all
 * generic styles. This makes it easier to apply custom styling; you won't
 * have to explicitly override styling you don't want.
 *
 * @property generic
 * @type Boolean
 * @default true
 */

/**
 * Returns the positional index for the indicated item.
 *
 * @method indexOfItem
 * @param {Object} item The item whose index is requested.
 * @returns {Number} The index of the item, or -1 if not found.
 */

/**
 * The current set of items in the list.
 *
 * @property items
 * @type [Object]
 */

/**
 * Fires when the items in the list change.
 *
 * @event items-changed
 */

/**
 * Fires when a new item has been selected.
 *
 * @event selected-item-changed
 * @param detail.selectedItem The new selected item.
 * @param detail.previousItem The previously selected item.
 */

/**
 * The index of the item which is currently selected, or -1 if there is no
 * selection.
 *
 * @property selectedIndex
 * @type Number
 */

/**
 * The currently selected item, or null if there is no selection.
 *
 * @property selectedItem
 * @type Object
 */

/**
 * Select the first item in the list.
 *
 * @method selectFirst
 */

/**
 * Select the last item in the list.
 *
 * @method selectLast
 */

/**
 * Select the next item in the list.
 *
 * @method selectNext
 */

/**
 * Select the previous item in the list.
 *
 * @method selectPrevious
 */
</script>
