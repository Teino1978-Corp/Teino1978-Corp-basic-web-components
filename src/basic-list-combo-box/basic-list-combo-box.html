<!--
A combo box which presents its choices as a dropdown list.

@element basic-list-combo-box
@demo http://basic-web-components.github.io/basic-web-components/src/basic-list-combo-box/?dom=shadow
-->

<link rel="import" href="../basic-combo-box/basic-combo-box.html">
<link rel="import" href="../basic-list-box/basic-list-box.html">

<dom-module id="basic-list-combo-box">
  <template>

    <style>
    :host {
      display: -webkit-inline-flex;
      display: inline-flex;
    }

    #comboBox {
      -webkit-flex: 1;
      flex: 1;
    }

    #listBox {
      --basic-list-box: {
        border: none;
      };
    }
    </style>

    <basic-combo-box id="comboBox" dont-open-on-focus="{{dontOpenOnFocus}}">
      <basic-list-box id="listBox" class="popup" selected-item="{{selectedItem}}" tabindex="-1">
        <content></content>
      </basic-list-box>
    </basic-combo-box>

  </template>
</dom-module>

<script>
Polymer({

  is: 'basic-list-combo-box',

  get inputElement() {
    return this.$.comboBox.inputElement;
  },

  get items() {
    return this.$.listBox.items;
  },

  ready: function() {

    // HACK: Ask to do work when the combo box opens.
    this.$.comboBox._openHook = this._open.bind(this);

    // Indicate which navigation keys we want to handle.
    this.$.comboBox.popupKeys = [
      33, // Page Up
      34, // Page Down
      35, // End
      36, // Home
      38, // Up
      40  // Down
    ];

    // Show default value.
    // See note at value getter/setter.
    var defaultValue = this.getAttribute('value');
    if (this.value !== defaultValue) {
      this.value = defaultValue;
    }

  },

  get popupElement() {
    return this.$.comboBox.popupElement;
  },

  properties: {

    dontOpenOnFocus: {
      notify: true,
      type: Boolean,
      value: false
    },

    selectedItem: {
      notify: true,
      observer: '_selectedItemChanged',
      type: Object
    },

  },

  /**
   * The text value in the combo box.
   *
   * @property value
   * @type String
   */
  // We'd prefer to define this as a normal property and bind it to the combo
  // box's value property, but of 9/10/15, that didn't work.
  get value() {
    return this.$.comboBox.value;
  },
  set value(text) {
    this.$.comboBox.value = text;
    var event = new CustomEvent('value-changed');
    this.dispatchEvent(event);
  },

  _open: function() {
    // Try to select the list item whose text matches the current text.
    console.log("Trying to select " + this.value);
    this.$.listBox.value = this.value;
  },

  _selectedItemChanged: function() {
    var selectedItem = this.selectedItem;
    var inputElement = this.inputElement;
    if (inputElement) {
      var value = selectedItem instanceof HTMLElement ? selectedItem.textContent : selectedItem;
      inputElement.value = value;
    }
  }

});
</script>
